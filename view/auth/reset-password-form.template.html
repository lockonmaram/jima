<html>
  <h1>Reset Password</h1>

  <style>.hide{display:none}</style>

  <div id="successPanel" class="hide">
    <h2>Password reset successful âœ…</h2>
  </div>

  <form id="resetForm" action="{{ .Action }}" method="post">
    <input type="hidden" id="token" name="token" value="{{ .Token }}">

    <label>
      New Password:
      <input type="password" id="password" name="password" required minlength="8">
    </label>
    <br>

    <label>
      Confirm Password:
      <input type="password" id="confirmPassword" name="confirm_password" required minlength="8">
    </label>
    <br>

    <p id="errorMsg" style="color:red"></p>

    <button id="submitBtn" type="submit">Reset Password</button>
  </form>

  <script>
    const form = document.getElementById('resetForm');
    const successPanel = document.getElementById('successPanel');
    const errorMsg = document.getElementById('errorMsg');
    const submitBtn = document.getElementById('submitBtn');

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      errorMsg.textContent = '';

      const token = document.getElementById('token').value.trim();
      const password = document.getElementById('password').value.trim();
      const confirm  = document.getElementById('confirmPassword').value.trim();

      if (password !== confirm) {
        errorMsg.textContent = 'Passwords do not match';
        return;
      }

      submitBtn.disabled = true;

      try {
        const res = await fetch(form.action, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token, password, confirm_password: confirm })
        });

        if (!res.ok) {
          const errData = await res.json().catch(() => ({}));
          throw new Error(errData.message || 'Request failed');
        }

        form.classList.add('hide');
        successPanel.classList.remove('hide');
        form.reset();
      } catch (err) {
        const errorResponse = JSON.parse(err.message)
        errorMsg.textContent = 'Error: ' + errorResponse.error;
      } finally {
        submitBtn.disabled = false;
      }
    });
  </script>
</html>